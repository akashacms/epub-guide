---
layout: page.html.ejs
title: The AkashaCMS rendering process
---

This is what we've been working towards for a few sections - rendering HTML files from any content file.  The EPUB3 specification uses the XHTML variant of HTML5 and CSS for the rendered content.  That's our goal at the moment, to take a Markdown file and turn it into XHTML5 suitable for display on an EPUB reader.  At the end of this section we'll we'll know how to do this.  Promise.


The AkashaCMS website does have complete documentation about layouts and page rendering at - [akashacms.com/layout/index.html](http://akashacms.com/layout/index.html)

Generally speaking, AkashaCMS encapsulates the content within a series of layout template files as determined by layout tags in the templates.  As content is rendered into template after template, the complete HTML page structure is built.  Any document file or template file with a `layout` tag will be rendered into the named template.  Let's make this clearer with an example.

This guide is formatted using `page.html.ejs`, meaning each page in the guide has this metadata:

```
    ---
    layout: page.html.ejs
    title:  Whatever the Title is
    ---
```

The `layout` tag tells AkashaCMS which layout template to use.

Then the `page.html.ejs` template ([github.com/akashacms/epub-guide/blob/master/layouts/page.html.ejs](https://github.com/akashacms/epub-guide/blob/master/layouts/page.html.ejs)) reads as follows:

```
    ---
    layout: epub_page.html.ejs
    ---
    <header><h1><%= title %></h1></header>
    <%- content %>
```

This template also has a layout tag pointing to another template.  This one, `epub_page.html.ejs`, is part of the akashacms-epub project ([github.com/akashacms/akashacms-epub/blob/master/layouts/epub_page.html.ejs](https://github.com/akashacms/akashacms-epub/blob/master/layouts/epub_page.html.ejs)).

What we've just described is the sequence of rendering pages using these specific templates.  The original Markdown file is rendered as HTML, then rendered inside `page.html.ejs` using the EJS engine, and that rendering is again rendered using EJS through the `epub_page.html.ejs` template.  The result is XHTML5 suitable for an EPUB reader, because the final template was designed for that purpose.

Since the `epub_page.html.ejs` template does not have a `layout` tag the rendering process stops at that point.  That is, the AkashaCMS rendering process continues so long as the layout template has a `layout` tag.

The resulting rendered files depends on the sequence of layout templates being used.  This sequence happens to end in a template conforming to XHTML5.  For regular websites an AkashaCMS user uses web-centric layout templates, and AkashaCMS provides the `ak_page.html.ejs` template ([github.com/akashacms/akashacms/blob/master/builtin/layout/ak_page.html.ejs](https://github.com/akashacms/akashacms/blob/master/builtin/layout/ak_page.html.ejs)) that's heavily influenced by the Boilerplate framework.

In `page.html.ejs` we see how metadata values, the `title` tag primarily, makes it into the rendered page. 

```
    <header><h1><%= title %></h1></header>
```

It being based on HTML5, EPUB3 uses many of the new tags like `header`.  

The `content` variable is autogenerated by AkashaCMS and contains the current state of the rendering.  This segment of the code inserts the rendering without any encoding:

```
    <%- content %>
```

Using `<%= variable %>` encodes the value to safe HTML, while the `<%- content %>` just inserts the value with no encoding.  This is bog-standard EJS behavior, and your templates use one or the other form depending on the circumstances.

EJS also lets you write code inside the template.  What if the `title` variable was left out of a content file?  The processing would crash at that point, and maybe your book doesn't require a section header at the beginning of each section.  Consider:

```
    <% if (title) { %>
    <header><h1><%= title %></h1></header>
    <% } %>
```

This says if the `title` tag is present, then render the `header` and `h1` tags shown here, but don't do so if there's no `title`.

The `epub_page.html.ejs` template can be studied in the github repository if you like ([github.com/akashacms/akashacms-epub/blob/master/layouts/epub_page.html.ejs](https://github.com/akashacms/akashacms-epub/blob/master/layouts/epub_page.html.ejs)).  It is a complete HTML file formatted correctly for use in an EPUB.

## Using data in a fancier template

As an example of more comprehensive metadata usage, consider a series of pages containing information tables.  The table data could be given as metadata, and the layout template could format that data into an HTML table, and encapsulate it into a complete HTML file.

Suppose you were writing a book of ice cream sundae recipes.  The metadata could list the ingredients, while the content could describe how to assemble the Sundae and perhaps author remniscences (and pictures) from childhood visits to Atlantic City.  

Consider - `banana-split.html.md`

```
    ---
    layout: ice-cream-sundae.html.ejs
    title: Banana Split Sundae
    dish-style: Tray
    base: 1 Banana, cut in half lengthwise
    flavors: Vanilla
    topping: Chocolate Syrup
    sprinkles: Peanuts
    image: images/sundaes/banana-split.png
    ---
    
    In the summer of 1967 I had my first REAL banana split
    sundae, and I thought I'd gone to heaven it was so good.
    These are easy to make and sure to be a crowd pleaser.
    ...
```

Plausible template - `ice-cream-sundae.html.ejs`

```
    ---
    layout: page.html.ejs
    ---
    
    <img src="<%- image %>"/>
    
    <table>
    <tr><th>Dish style</th><td><%= dish-style %></td></tr>
    <tr><th>Base</th><td><%= base %></td></tr>
    <tr><th>Ice Cream Flavor</th><td><%= flavors %></td></tr>
    <tr><th>Topping</th><td><%= topping %></td></tr>
    <tr><th>Sprinkles</th><td><%= sprinkles %></td></tr>
    </table>
    
    <div><%- content %></div>
```

This template takes care of formatting the image, the table and the description.  It's then passed on to the `page.html.ejs` we looked at earlier, which adds the H1 title at the top.

## Real-world -- Per-chapter indexes in this very guide

You may have noticed that each Chapter in this guide starts with an overview discussion, and then a list of links to sections within the chapter.  Rather than maintain that link list as HTML, it is stored as document metadata.

```
    ---
    layout: chapter-index.html.ejs
    title: Creating book content to be rendered by AkashaEPUB 
    chapterNumber: 3
    sections: 
      - url: 3a-document-format.html
      - url: 3b-metadata.html
      - url: 3c-content-markup.html
      - url: 3d-rendering.html
      - url: 3e-html5-structure.html
    ---
```

Remember that the document metadata is really a YAML structure.  That bit with ` - url: ` on several lines is the method for writing a list in YAML.  This defines a list named `sections` containing value objects with a field named `url`.

Everything is handled within the `chapter-index.html.ejs` layout template.

The `chapterNumber` value is used this way:

```
<header><h1><%
  if (typeof chapterNumber !== 'undefined') {
    %>Chapter <%= chapterNumber %>: <%
  }
%><%= title %></h1></header>
```

Hence, if `chapterNumber` is present then the title is prefixed with "Chapter #:" giving the reader a clue that they're in a new chapter.

The chapter index is rendered this way:

```
<%
if (typeof sections !== 'undefined') {
%>
<aside class="section-list">
<ul>
<%
sections.forEach(function(section) {
    %><li><a href="<%= section.url %>"></a></li><%
});
%>
</ul>
</aside>
<% } %>
```

If `sections` is present it's going to be a list, which one traverses with the `.forEach` method as shown.  Hence this is straight-forward to understand:  An `<li>...</li>` is rendered for each member of the `sections` list, giving a link to the document with empty anchor text.  As we'll see later (see [](4f-links.html)), AkashaEPUB automatically looks up the `title` of the document, using that as the anchor text of the link.

The result is an easy-to-maintain index of the chapters and sections.

## Asset files, CSS, Images, fonts, etc

While we just succeeded in rendering an XHTML file this isn't tne end of making sure your content looks good in an EPUB reader.  As in the web-centric world, HTML pages are improved when you have images use CSS to customize the display, and use better fonts.

All this is discussed in the next chapter, [](4g-assets.html).
